<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Air Pollution Injustice in Houston</title>

  <meta name="viewport" content="width=device-width">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">


  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
 integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
 crossorigin=""/>
 <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
crossorigin=""></script>
<!-- bivariate choropleths -->
<!-- font -->
<link rel="preconnect" href="https://fonts.gstatic.com">
<link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet">
<!-- easy button -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.css">
<script src="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.js"></script>
<!-- search Bar -->
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
<!-- L.Control.Button -->
<script src="https://raw.githubusercontent.com/jerroydmoore/leaflet-button/b568e84f4e46167c4a8a8f640e2b192afdc34930/L.Control.Button.js"></script>
<!-- data files -->
<script src="HoustonData/houNo2SEPT.js"></script> <!-- Houston data -->
<script src="https://k-mcc.github.io/no2WithDemIndex.js"></script> <!-- D.C. data -->
<!-- pie chart -->
<script src="https://cdn.anychart.com/releases/8.0.1/js/anychart-core.min.js"></script>
<script src="https://cdn.anychart.com/releases/8.0.1/js/anychart-pie.min.js"></script>

<script src="https://k-mcc.github.io/geoJSON/houNHPoints.js"></script>
<script src="geoJSON/dcNHPoints.js"></script>
<script src="geoJSON/houSources.js"></script>
<link rel="stylesheet" href="css/no2EqualityMapsNav.css">
  <style>

  </style>
</head>
<body>

  <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" integrity="sha384-w1Q4orYjBQndcko6MimVbzY0tgp4pWB4lZ7lr30WKz0vr/aWKhXdBNmNb5D92v7s" crossorigin="anonymous"></script>

  <nav class="navbar navbar-expand-md">
    <a class="navbar-brand" href="houston-in-dev.html">Air Pollution Injustice</a>
    <a class="navbar-brand" href="https://forms.gle/pdiqNVtPRMa8fYNp9" target="_blank" rel="noopener noreferrer"><span class="nav-ref">Provide Feedback</span></a>
    <button class="navbar-toggler navbar-dark" type="button" data-toggle="collapse" data-target="#main-navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="main-navigation">
      <ul class="navbar-nav">
        <li class="nav-item">
          <a class="nav-link active" href="houston-in-dev.html">Map</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="about-the-data.html">Data</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="story-map.html">Story</a>
        </li>
      </ul>
    </div>
  </nav>

  <nav class="navbar fixed-bottom navbar-light bg-light navbar-expand-md" style="z-index:1001; justify-content:left;">
    <button class="navbar-toggler navbar-dark" type="button" data-toggle="collapse" data-target="#toolbar">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="toolbar">
    <!-- Maps -->
    <div class="btn-group dropup" style="float:left;">
      <button type="button" class="btn btn-secondary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
        Maps
      </button>
      <div class="dropdown-menu">
        <!-- Dropdown menu links -->
        <div class='chorOption' id='returnBtn' onclick = "returnToBivariate()">NO<sub>2</sub> Equality Index (Default)</div>
        <div class='chorOption' id='popAsianBtn' onclick = "showUniChoropleth('popAsian',2)">Asian</div>
        <div class='chorOption' id='popBlackOrAfrAmerBtn' onclick = "showUniChoropleth('popBlackOrAfrAmer',3)">Black or African American</div>
        <div class='chorOption' id='popHispanicBtn' onclick = "showUniChoropleth('popHispanic',4)">Hispanic or Latino</div>
        <div class='chorOption' id='popWhiteBtn' onclick = "showUniChoropleth('popWhite',5)">White (Non-Hispanic)</div>
      </div>
    </div>

    <!-- View Options -->
    <div class="btn-group dropup">
      <button type="button" class="btn btn-secondary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
        View Options
      </button>
      <div class="dropdown-menu">
        <!-- Dropdown menu links -->
        <div class='chorOption' id='fillBtn' onclick = "toggleOpacity('fill')">Fill</div>
        <div class='chorOption' id='outlineBtn' onclick = "toggleOpacity('outline')">Outline</div>
      </div>
    </div>

    <!-- View Options -->
    <div class="btn-group dropup">
      <button type="button" class="btn btn-secondary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
        Colors
      </button>
      <div class="dropdown-menu">
        <!-- Dropdown menu links -->
        <div class='chorOption selected' id='button1' onclick = "setPalette(1)">&nbsp; 1<i id="a0"></i><i id="a1"></i><i id="a2"></i><i id="a3"></i></div>
        <div class='chorOption' id='button2' onclick = "setPalette(2)">&nbsp; 2<i id="b0"></i><i id="b1"></i><i id="b2"></i><i id="b3"></i></div>
      </div>
    </div>

    <div class="toggleBtnHolder">
      <button id="sources" type="button" class="btn" onclick="toggleLayer('sources')">
        NO<sub>X</sub> Sources
      </button>
    </div>

    </div>

  </nav>

  <body onload="load()">
  <div class='showLegendButton' id='gridContainerButton' ><h2>Legend</h2></div>


  <div id="map"></div>
  <div id="myModal" class="modal">

    <!-- Modal content -->
    <div class="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
      <h3>Houston's NO<sub>2</sub> Equality Map</h3>
      <p>Where we live, work, and spend our time affects how much nitrogen dioxide (NO<sub>2</sub>) and other air pollutants we breathe. Many primary pollutants, including NO<sub>2</sub>, vary between neighborhoods in the same city. On average, Houston’s low-income residents and residents of color experience 30% higher burdens of NO<sub>2</sub>.</br></br>The NO<sub>2</sub> Equality Map aims to draw attention to this injustice as it compares NO<sub>2</sub> column densities and socio-demographic vulnerability. The NO<sub>2</sub> Equality Map currently displays data measured from space by <a href="http://www.tropomi.eu/" target="_blank" rel="noopener noreferrer">TROPOMI</a> on weekdays (September 2018 and 2019) at the census tract level. In the future, the NO<sub>2</sub> Equality Map will update in real time.</p>
      <img src="images/IntroSlide4.png" alt="Introduction" style="width:1000px;height:600px;"> <!--2150px x 1350px-->
      <div class='exploreBtnContainer' onclick="closeModal()"><div class='exploreBtn' id='exploreBtn' onclick="closeModal()"><h2>Explore</h2></div></div>
    </div>

  </div>
<script>

  var mapboxAccessToken = 'pk.eyJ1Ijoia2F0ZW1hcCIsImEiOiJja3A0NWV0ZTkwNjBtMm5vdWxzcXR6dWxjIn0.7rYO_pPmtvwuWUb0cG3QXQ';
  var map = L.map('map').setView([29.7604, -95.3698], 12);
  var nhLayerIsOn;

  map.doubleClickZoom.disable();

  function load() {
    addChoropleth("Houston");
    currentOpacity = "";
    toggleOpacity("fill");
  }

  var firstZoom = true;
  map.on('zoom', function () {

      var opacity;

      var arr = document.getElementsByClassName("neighborhoodLabel");

      var display = "";
      var className = "neighborhoodLabel";
      if (map.getZoom() < 14 && !firstZoom) {
        className = 'neighborhoodLabel fade-out-text';
        //opacity = 0;
      }
      else if (map.getZoom() >= 14) {
        className = 'neighborhoodLabel fade-in-text';
        display = "inline-block";
        firstZoom = false;
      }

      arr = document.getElementsByClassName("neighborhoodLabel");

      for (var i = 0; i < arr.length; i++) {
        arr[i].className = className;
        if (display != "")  arr[i].style.display = display;
      }
      var size = getFontSizeTop10(map.getZoom());

      var className = "top10";
      if (map.getZoom() < 12) className = 'top10 fade-out-text-top10';
      else if (map.getZoom() >= 12) {
        className = 'top10 fade-in-text-top10';
        if (!nhLayerIsOn) {
          nhLayer = L.geoJson(houNHs, {
            pointToLayer: paint
          }); //{layout: layout}
          nhLayer.addTo(map);
          nhLayerIsOn = true;
        }
      }

      arr = document.getElementsByClassName("top10");

      for (var i = 0; i < arr.length; i++) {
        arr[i].className = className;
        arr[i].style.fontSize = size;
      }
  });

  function getFontSize(z) { // z = zoom level
    return z >= 16  ? 18 :
           z >= 15  ? 16 :
           z >= 14  ? 14 :
           z >= 13  ? 0 :
           z >= 12  ? 0 :
           z >= 11  ? 0 :
                    0;
  }

  function getTextOpacity(z) { // z = zoom level
    return z >= 16  ? 1 :
           z >= 15  ? 0.9 :
           z >= 14  ? 0.6 :
           z >= 13  ? 0.3 :
           z >= 12  ? 0 :
           z >= 11  ? 0 :
                    0;
  }

  function getFontSizeTop10(z) { // z = zoom level
    return z >= 16  ? 26 :
           z >= 15  ? 24 :
           z >= 14  ? 22 :
           z >= 13  ? 20 :
           z >= 12  ? 18 :
           z >= 11  ? 12 :
                    10;
  }
  function getOpacityTop10(z) { // z = zoom level
    return z >= 12  ? 1 :
           z >= 11.5  ? 0.7 :
           z >= 11  ? 0.4 :
           z >= 10.5  ? 0.1 :
                    0;
  }


//var settingName = [fillOpacity, outlineWeight, outlineColor]
  var opacityFills = [0.9, 0.5, "white"];
  var opacityOutlines = [0.1, 3, 0];
  var opacitySetting;
  var currentOpacity;
  function toggleOpacity(setting) {
    if (setting == "outline") {
      if (currentOpacity == "outline") return "";
      opacitySetting = opacityOutlines;
      currentOpacity = "outline";
      changeButtonSelection("outlineBtn", "fillBtn");
    }
    else  if (setting == "fill") {
      if (currentOpacity == "fill") return "";
      opacitySetting = opacityFills;
      currentOpacity = "fill";
      changeButtonSelection("fillBtn", "outlineBtn");
    }

    numVars = 2;

    fillOpacityVal = opacitySetting[0];
    weightVal = opacitySetting[1];
    colorVal = opacitySetting[2];

    var sourcesWasOn = false;
    if (sourcesIsOn) {
      sourcesWasOn = true;
      toggleLayer(sources);
    }

      if (houstonIsOn) { // Repaint Houston layer
        if (singleLayerOn == "") {
          map.removeLayer(houston);

          geojson = L.geoJson(houLayer);

          houston = L.geoJson(houLayer, {
              style: style,
              onEachFeature: onEachFeature
          });

          var layer = houston.addTo(map);

          geojson = layer;
        }
        else {
          map.removeLayer(univariateChoropleth);

          addChoropleth(singleVariable);
        }
      }
      if (dcIsOn) { // Repaint DC layer
        map.removeLayer(dc);

        geojson = L.geoJson(dcLayer);

        dc = L.geoJson(dcLayer, {
            style: style,
            onEachFeature: onEachFeature
        });
        var layer = dc.addTo(map);

        geojson = layer;
      }

      if (sourcesWasOn) {
        toggleLayer(sources);
      }

      zoom = false;
      zoomToFeature(clickEvent);
      zoom = true;
  }

  //countCityClicks = 1;

  var tileL = L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=' + mapboxAccessToken, {
      id: 'mapbox/light-v9',
      attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
      tileSize: 512,
      zoomOffset: -1
  }).addTo(map);

  // city markers
  var houName = "Houston";
  var wdcName = "Washington, D.C.";
  //var hou = addCityMarker(houName, 'pie'); //plots Houston's city marker
  //var wdc = addCityMarker(wdcName, 'pie'); //plots DC's city marker
  var currentCityMarkerType;
  var gridContainerID = "gridContainer";
  var explodedPieSect = 0;
  //var donutLegendID = "donutLegend";
  //var cities = L.layerGroup(hou, wdc);

  var dropdownIDs = ["myDropdown", "designDropdown"];
  var dropdownShowing = "";

  function toggleChorDropdown(id) {
    document.getElementById(id).classList.toggle("show");
    /*for (var i = 0; i < dropdownIDs.length; i++) {
      if (dropdownIDs[i] == id) {
        document.getElementById(id).classList.toggle("show");
      }
      /else if (dropdownIDs[i] == dropdownShowing) {
        document.getElementById(dropdownShowing).classList.toggle("show");
      }
    }
    dropdownShowing = id;*/
  }

  function returnToBivariate() {
    if (singleLayerOn != "") {
      explodedPieSect = 0;
      toggleUnivariateChoropleth(singleVariable);
      changeButtonSelection("returnBtn", singleVariable + "Btn");
      singleVariable = "";
    }
  }

  function showUniChoropleth(race, sectionNum) {
    explodedPieSect = sectionNum;
    toggleUnivariateChoropleth(race);
  }

  function numberWithCommas(x) {
    return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
  }

    // Get the modal
  var modal = document.getElementById("myModal");

  // Get the <span> element that closes the modal
  var xLightbox = document.getElementsByClassName("close")[0];

  // When the user clicks on <span> (x), close the modal
  function closeModal() {
    modal.style.display = "none";
    //var infoBoxDiv =document.getElementById("info");
    //infoBoxDiv.style.display = "block";
    //document.getElementById("gridContainer").style.display = "inline-grid";
  }

  // When the user clicks anywhere outside of the modal, close it
  window.onclick = function(event) {
    if (event.target == modal) {
      modal.style.display = "none";
    }
  }

/*  function returnToBivariate(specialCase) {
    if (singleLayerOn != "") {
      map.removeLayer(univariateChoropleth);
      document.getElementById(propName + "Btn").style.background = "#FFFFFF";
      document.getElementById(propName + "Btn").style.color = "#000000";
      singleLayerOn = "";
    }
  }*/

  /*function load() {
    setTimeout(
    function() {
      addChoropleth(houName);
      map.options.minZoom = 10;
      map.options.maxZoom = 30;
      //map.setView([29.7604, -95.3698], 11);
      countCityClicks++;
      map.flyTo([29.7604, -95.3698], 11, {duration: 1, easeLinearity: 0.2});
    }, 2000);

  }*/

  function popItUp(elementID) { // displays popup element
    var popup = document.getElementById(elementID);
    if (popup != null) popup.classList.toggle("show");
  }

  function xButton(elementID, defaultDisplay) { // sets element display to none
    var ele = document.getElementById(elementID);
    if (ele != null) {
      ele.style.display = "none";
      makeShowLegendButton(elementID, defaultDisplay);
    }
  }

  function showLegend(legendID, defaultDisplay) {
    var legend = document.getElementById(legendID);
    if (legend != null) legend.style.display = defaultDisplay;
    var button = document.getElementById(legendID + 'Button');
    button.style.display = "none";
    var index = hiddenLegends.indexOf(legendID);
    hiddenLegends.splice(index, 1);
  }

  function makeShowLegendButton(legendID, defaultDisplay) {
    var button = document.getElementById(legendID + "Button");
    button.onclick = function() {
      showLegend(legendID, defaultDisplay)
    };
    button.style.display = "block";
    hiddenLegends.push(legendID);
  }

  // bivariate choropleths

  var colors;
  var geojson;
  var clickedTract;
  var previousTarget;
  var clickEvent;
  var img = L.control({position: 'bottomleft'});
  var info = L.control();

  var searchBar = L.Control.geocoder({position: 'topleft'});
  searchBar.addTo(map);

  var numVars;
  var singleVariable;
  var univariateChoropleth;
  var singleLayerOn;
  /*var univariateButton = L.easyButton('<img src="images/countryView.png" alt="Zoom out to country" style="width:24px;height:20px;position:absolute;left: -1; right: -3px; top: 4px; bottom: 0px;">', function(btn, map){
      numVars = 1;
      addChoropleth("white");
  });*/
  var zoom = true;
  var houston; // Houston's choropleth layer
  var dc; // D.C.'s choropleth layer
  var houstonIsOn;
  var dcIsOn;
  var countCityClicks = 1;
  var firstTimeInCity = true;
  var hiddenLegends = [];
  var nhLayer;

  function addChoropleth(cityName) {

    var sourcesWasOn = false;
    if (sourcesIsOn) {
      sourcesWasOn = true;
      toggleLayer(sources);
    }

    if (firstTimeInCity) {
      clickedTract = "";
      previousTarget = "";
      clickEvent = "";
      zoom = true;

      if (countCityClicks == 1) {
        colors = paletteA;
        changeButtonSelection("button1","button2");
      }

      singleLayerOn = "";
      firstTimeInCity = false;
    }

    if (cityName == "Houston") { // Add Houston layer
      numVars = 2;
      houstonIsOn = true;
      if (singleLayerOn != "") {
        toggleUnivariateChoropleth(singleVariable);
      }
      singleLayerOn = "";

      geojson = L.geoJson(houLayer);

      houston = L.geoJson(houLayer, {
          style: style,
          onEachFeature: onEachFeature
      });

      var layer = houston.addTo(map);

      geojson = layer;
      if (map.getZoom >= 12) {
        nhLayer = L.geoJson(houNHs, {
          pointToLayer: paint
        }); //{layout: layout}
        nhLayer.addTo(map);
        nhLayerIsOn = true;
      } else {
        nhLayerIsOn = false;
      }

      img.addTo(map);

      if (hiddenLegends.includes(gridContainerID)) {
        document.getElementById(gridContainerID).style.display = "none";
        document.getElementById(gridContainerID + "Button").style.display = "block";
      }
      info.addTo(map);

      changeButtonSelection("returnBtn","");
    }
    else if (cityName == "Washington, D.C.") {  // Add DC layer
      numVars = 2;
      dcIsOn = true;
      if (singleLayerOn != "") {
        toggleUnivariateChoropleth(singleVariable);
      }
      singleLayerOn = "";

      geojson = L.geoJson(dcLayer);

      dc = L.geoJson(dcLayer, {
          style: style,
          onEachFeature: onEachFeature
      });
      var layer = dc.addTo(map);

      geojson = layer;

      img.addTo(map);

      if (hiddenLegends.includes(gridContainerID)) {
        document.getElementById(gridContainerID).style.display = "none";
        document.getElementById(gridContainerID + "Button").style.display = "block";
      }

      info.addTo(map);

      changeButtonSelection("returnBtn","");
    }
    else {
      numVars = 1;
      singleVariable = cityName;

      var buttonID = singleVariable + "Btn";
      changeButtonSelection(buttonID,"");

      if (houstonIsOn) { // Remove Houston layer
        map.removeLayer(houston);

        geojson = L.geoJson(houLayer);

        univariateChoropleth = L.geoJson(houLayer, {
            style: style,
            onEachFeature: onEachFeature
        });

        var layer = univariateChoropleth.addTo(map);

        geojson = layer;
      }

      if (hiddenLegends.includes(gridContainerID)) {
        document.getElementById(gridContainerID).style.display = "none";
        document.getElementById(gridContainerID + "Button").style.display = "block";
      }

      info.addTo(map);
    }

    if (sourcesWasOn) {
      toggleLayer(sources);
    }

  }

  function paint(feature, latlng) {

    var textLabel = feature.properties.SNBNAME

    var top10 = feature.properties.Top10;
    var addClass = "neighborhoodLabel ";

    if (top10 == "Y") addClass = " top10  fade-in-text-top10 "; //top10

    var nhTextIcon = L.divIcon({
      className: 'nhMarker',
      html: "<h4 class='" + addClass + "'>" + feature.properties.SNBNAME + "</h4>",
      iconSize: [200,10]
    });

    //var
    //element.style.setProperty("--nhFactor", feature.properties.ShapeSTArea);

    return L.marker(latlng, {
       icon: nhTextIcon,
       title: feature.properties.SNBNAME,
       interactive: false
    });
  }

  function toggleUnivariateChoropleth(propName) {

    firstTimeInCity = false;

    if (singleLayerOn == propName) {
      map.removeLayer(univariateChoropleth);
      changeButtonSelection(propName + "Btn", "");
      //remove uni legend, too
      singleLayerOn = "";
      addChoropleth(houName);
      addChoropleth(wdcName);
    }

    else if (singleLayerOn != "") {
      map.removeLayer(univariateChoropleth);
      changeButtonSelection("", singleVariable + "Btn");
      changeButtonSelection("", "returnBtn");

      map.removeLayer(univariateChoropleth);

      singleLayerOn = propName;
      addChoropleth(propName);

      uniLegend();
    }

    else {
      changeButtonSelection(propName + "Btn", "returnBtn");
      singleLayerOn = propName;
      addChoropleth(propName);
      uniLegend();
    }

  }

  function removeChoroplethControls() {

      document.getElementById(gridContainerID).style.display = "none";
      document.getElementById(gridContainerID + "Button").style.display = "none";
      var squares = document.getElementsByClassName("grid-item");
      for (i = 0; i < squares.length; i++) {
        squares[i].style.display = "none";
      }
      var axes = document.getElementsByClassName("axis");
      for (i = 0; i < axes.length; i++) {
        axes[i].style.display = "none";
      }
      var infoBoxDiv =document.getElementById("info");
      infoBoxDiv.style.display = "none";
      if (houstonIsOn) { // Remove Houston layer
        map.removeLayer(houston);
        houstonIsOn = false;
      }
      if (dcIsOn) { // Remove DC layer
        map.removeLayer(dc);
        dcIsOn = false;
      }

      document.getElementById("button1").style.display = "none";
      document.getElementById("button2").style.display = "none";

  }

  // Joshua Stevens
  //var paletteA = ['#E8E8E8', '#ACE4E4', '#5AC8C8', '#DFB0D6', '#A5ADD3', '#5698B9', '#BE64AC', '#8C62AA', '#3B4994'];     // sq1                                   sq2                                  sq3                                 top10
  var paletteA = ['#E8E8E8', '#ACE4E4', '#5AC8C8', '#DFB0D6', '#A5ADD3', '#5698B9', '#BE64AC', '#8C62AA', '#3B4994',       '#D79DCC', '#CF8AC1', '#C677B7',        '#9F9AC9', '#9988BF', '#9275B4',      '#4F84B0', '#4971A7', '#425D9D',      '#FFFF00'];
  /*
  '#BE64AC' '#8C62AA' '#3B4994'


  '#DFB0D6' '#A5ADD3' '#5698B9'


  '#E8E8E8' '#ACE4E4' '#5AC8C8' */
  for (var i = 0; i < 4; i++) {
    var corners = [0, 2, 6, 8];
    var idStr = "a" + i;
    document.getElementById(idStr).style.background = paletteA[corners[i]];
  }
  // gridA.png option 2 //                                                                                                      sq1                                   sq2                                       sq3                             top10
  var paletteB = ['#F3F3F3', '#B4D3E1', '#509DC2', '#F3E6B3', '#B3B3B3', '#376387', '#F3B300', '#B36600', '#000000',         '#F3D986', '#F3CD5A', '#F3C02D',        '#B3A086', '#B38D5A', '#B3792D',      '#294A65', '#1C3244', '#0E1922',      '#00CC00'];
  /*
  '#F3B300', '#B36600', '#000000'


  '#F3E6B3', '#B3B3B3', '#376387',


  '#F3F3F3', '#B4D3E1', '#509DC2',
  */

  for (var i = 0; i < 4; i++) {
    var corners = [0, 2, 6, 8];
    var idStr = "b" + i;
    document.getElementById(idStr).style.background = paletteB[corners[i]];
  }

  img.onAdd = function (map) {
    var div = L.DomUtil.create('div', 'grid-container');
    div.id = gridContainerID;
    div.style.display = "inline-grid";
    div.style.zIndex = 200;
    var grades = [1, 40, 99];
    //<div class='popup' onclick='popItUp(\"no2AxisPopup\")' style='bottom:5px; left:5px;'><img src='images/info.png' style='width:30px;height:30px;'></img><span class='popuptext' id='no2AxisPopup'><p><strong>Title: </strong></br>Description</p></span></div>
    //div.innerHTML += '<img src="images/no2dLegend.png" alt="Legend" style="width:300px;height:300px;">';
    div.innerHTML += "<div class='xButton' onclick='xButton(\"gridContainer\", \"inline-grid\")' ><h2 style='top: -47px; left: -26px'>✕</h2></div><h3 class='axis'>Nitrogen Dioxide Percentile</h3><div class=\"grid-item\" style=\"background:" + getColor(grades[2],grades[0],"") + "\" id:\"a3\" ></div><div class=\"grid-item\" style=\"background:" + getColor(grades[2],grades[1],"") + "\" id:\"b3\" ></div><div class=\"grid-item\" style=\"background:" + getColor(grades[2],grades[2],"") + "\" id:\"c3\" ></div>";
    div.innerHTML += "<div class=\"grid-item\" style=\"background:" + getColor(grades[1],grades[0],"") + "\" id:\"a2\"></div><div class=\"grid-item\" style=\"background:" + getColor(grades[1],grades[1],"") + "\" id:\"b2\" ></div><div class=\"grid-item\" style=\"background:" + getColor(grades[1],grades[2],"") + "\" id:\"c2\" ></div>";
    div.innerHTML += "<div class=\"grid-item\" style=\"background:" + getColor(grades[0],grades[0],"") + "\" id:\"a1\" ></div><div class=\"grid-item\" style=\"background:" + getColor(grades[0],grades[1],"") + "\" id:\"b1\" ></div><div class=\"grid-item\" style=\"background:" + getColor(grades[0],grades[2],"") + "\" id:\"c1\" ></div><h2 class='axis' >Socio-Demographic Index</h2>";

    //var draggable = new L.Draggable(div);
    //draggable.enable();

    return div;
  }

  info.onAdd = function (map) {
      this._div = L.DomUtil.create('div', 'info'); // create a div with a class "info"
      this._div.id = "info";
      this.update();
      var draggable = new L.Draggable(this._div);
      draggable.enable();
      return this._div;
  };

  info.update = function (props) {
      this._div.innerHTML = '<h2>NO<sub>2</sub> Equality Index</h2>' +  (props ?
          /*'<h4>NO<sub>2</sub> Percentile: ' + props.no2Perc + '</h4><br /><h4>Average NO<sub>2</sub> Vertical Column Density: ' + expo(props.no2Actual, 4) + ' molecules/cm<sup>2</sup></h4></br><h4>Socio-Demographic Percentile: ' + props.demographicIndex + '</h4><br /><h4>Tract #' + props.TRACT + '</h4></br><h4> $' + numberWithCommas(props.medianHHIncome) + '</h4></br>'
          : 'Click on a census tract');*/

          /*'</br><div style="column-count:2;"><h4 style="font-size:3em; color:' + adjustColor(props.no2Perc, 0) + ';column-span: 1;bottom:0px;padding:10px;">' + props.no2Perc + '</h4><h4 style="font-size:3em; color:' + adjustColor(0, props.demographicIndex) + ';column-span: 1;top:0;padding:0px;">' + props.demographicIndex + '</h4></div><h4>NO<sub>2</sub> Percentile:</h4></br><h4>Average NO<sub>2</sub> Vertical Column Density: ' + expo(props.no2Actual, 4) + ' molecules/cm<sup>2</sup></h4></br><h4>Socio-Demographic Percentile: <h4 style="font-size:3em; color:' + adjustColor(0, props.demographicIndex) + ';">' + props.demographicIndex + '</h4><br /><h4>Tract #' + props.TRACT + '</h4></br><h4> $' + numberWithCommas(props.medianHHIncome) + '</h4></br>'
          : 'Click on a census tract');*/

          '<h4 style="text-align: center;">Tract #' + props.TRACT + '</h4>' +
          '</br><div style="display: inline-grid;grid-template-columns: auto auto; height:3em;"><div class=\"grid-titem\" style="padding-left:10px;text-align:center;justify-content:center;width=150px;max-width: 100%;min-width: 100%;"><h4 style="font-size:3em; color:' + adjustColor(props.no2Perc, 0) + ';">' + props.no2Perc + '</br></h4><h4>NO<sub>2</sub> Percentile</h4></div><div class=\"grid-titem\" style="padding-right:0px;justify-content:center;text-align:center;width=150px;max-width: 100%;min-width: 100%;padding-left:0px;"><h4 style="font-size:3em; color:' + adjustColor(0, props.demographicIndex) + ';">' + props.demographicIndex + '</h4><h4>Socio-Demographic Percentile</h4></div></div>' +
          '<h4 style="margin-top: 50px;"><strong>Average NO<sub>2</sub> Vertical Column Density:</strong> ' + expo(props.no2Actual, 4) + ' molecules/cm<sup>2</sup></h4>' +
          '<div style="margin-top: 40px;display: inline-grid;grid-template-columns: auto auto; height:2em;padding-right:0px;"><div class=\"grid-titem\" style="padding-left:0px;text-align:center;width=150px;max-width: 100%;min-width: 100%;"><h4 style="font-size:2em;">$' + numberWithCommas(props.medianHHIncome) + '</h4></br><h4>Tract\'s Median Household Income</h4></div>' +
          '<div class=\"grid-titem\" style="padding-left:0px;text-align:center;width=150px;max-width: 100%;min-width: 100%;"><h4 style="font-size:2em;">$52,338</h4></br><h4>Houston\'s Median Household Income</h4>' +
          '</br></br>'
          : 'Click on a census tract');

          this._div.innerHTML += '<br /><br /><br /><br /><br /><br /><div id="infoBox" style="height: 400px;" ><br /></div>';

          var data = [
              {x: "American Indian/Alaska Native", value: (props ? props.popNativeAmer : 0)},
              {x: "Asian", value: (props ? props.popAsian : 0)},
              {x: "Black or African American", value: (props ? props.popBlackOrAfrAmer : 0)},
              {x: "Hispanic or Latino", value: (props ? props.popHispanic : 0)},
              {x: "White (Non-Hispanic)", value: (props ? props.popWhite : 0)}
          ];

          //this._div.innerHTML += (props ? props.pWhite : 'hi');

          // create the chart
          var chart = anychart.pie();

          // add the data
          chart.data(data);

          //if (explodedPieSect != 0) chart.select([explodedPieSect]);

          // display the chart in the container
          chart.container('infoBox');
          chart.draw();
          chart.legend().itemsLayout("vertical");
          //chart.sort("desc");
  };

  function adjustColor(prop1, prop2) {
    var suggestedColor = getColor(prop1,prop2,"");
    if (suggestedColor == colors[0] || suggestedColor == colors[1] || suggestedColor == colors[3]) { // if too light for a white background, change to black text.
      return LightenDarkenColor(suggestedColor, -50);
    }
    else if (singleLayerOn != "") { // if univariate choropleth
      return "#000000";
    }
    else return suggestedColor;
  }

  function LightenDarkenColor(colorCode, amount) {
    var usePound = false;

    if (colorCode[0] == "#") {
        colorCode = colorCode.slice(1);
        usePound = true;
    }

    var num = parseInt(colorCode, 16);

    var r = (num >> 16) + amount;

    if (r > 255) {
        r = 255;
    } else if (r < 0) {
        r = 0;
    }

    var b = ((num >> 8) & 0x00FF) + amount;

    if (b > 255) {
        b = 255;
    } else if (b < 0) {
        b = 0;
    }

    var g = (num & 0x0000FF) + amount;

    if (g > 255) {
        g = 255;
    } else if (g < 0) {
        g = 0;
    }

    return (usePound ? "#" : "") + (g | (b << 8) | (r << 16)).toString(16);
}



  function expo(x, f) {
    return Number.parseFloat(x).toExponential(f);
  }


  /*
  [ a3 ]  [ b3 ]  [ c3 ]

  [ a2 ]  [ b2 ]  [ c2 ]

  [ a1 ]  [ b1 ]  [ c1 ]
  */

    function getColor(axisA, axisB, variableA) {
      var x = variableA;
      if (numVars == 1) {
        return x >= 90  ? '#4D004B' :
               x >= 80  ? '#810F7C' :
               x >= 70  ? '#88419D' :
               x >= 60  ? '#8C6BB1' :
               x >= 50  ? '#8C96C6' :
               x >= 40   ? '#9EBCDA' :
               x >= 30   ? '#BFD3E6' :
               x >= 20   ? '#E0ECF4' :
               x >= 10   ? '#F7FCFD' :
               x > 0   ? '#FFFFFF' :
                        '#FFFFFF';
      }
      else if (numVars == 2) {
        var a = getRange(axisA);
        var b = getRange(axisB);

        if (a == 1) { //low axisA value
          if (b == 1) return colors[0]; //low axisB value
          else if (b == 2) return colors[1]; //mid axisB value
          else return colors[2]; //high axisB value
        }

        else if (a == 2) { //mid axisA value
          if (b == 1) return colors[3]; //low axisB value
          else if (b == 2) return colors[4]; //mid axisB value
          else return colors[5]; //high axisB value
        }

        else if (a == 3) { //high axisA value
          if (b == 1) return colors[9]; //low axisB value
          else if (b == 2) return colors[12]; //mid axisB value
          else return colors[15]; //high axisB value
        }

        else if (a == 4) { //high axisA value
          if (b == 1) return colors[10]; //low axisB value
          else if (b == 2) return colors[13]; //mid axisB value
          else return colors[16]; //high axisB value
        }

        else if (a == 5) { //high axisA value
          if (b == 1) return colors[11]; //low axisB value
          else if (b == 2) return colors[14]; //mid axisB value
          else return colors[17]; //high axisB value
        }

        else if (a == 6) { //high axisA value
          if (b == 1) return colors[6]; //low axisB value
          else if (b == 2) return colors[7]; //mid axisB value
          else return colors[8]; //high axisB value
        }
      }
    }

    function getRange(x) {
      return x >= 90  ? 6 :
             x >= 80  ? 5 :
             x >= 70  ? 4 :
             x >= 66.66  ? 3 : //high
             x >= 33.33  ? 2 : //mid
                      1; //low
    }

    function getColorRanked(rank, suggestedColor) {
      if (!(rank == null)) {
        if (singleLayerOn != "") return suggestedColor;
        return rank <= 25  ? colors[18] :
                          suggestedColor;
      }
      else return suggestedColor;
    }

    function getOutlineColor(rank, suggestedColor) {
      if (!(rank == null)) {
        return rank <= 25  ? colors[18] :
                          suggestedColor;
      }
      else return suggestedColor;
    }
    function getOutlineWeight(rank, suggestedWeight) {
      if (!(rank == null)) {
        if (singleLayerOn != "") return suggestedWeight;
        return rank <= 25  ? suggestedWeight+3:
                             suggestedWeight;
      }
      else return suggestedWeight;
    }

    function getOutlineOpacity(rank) {
      if (!(rank == null)) {
        return rank <= 25  ? 1 :
                          0.5;
      }
      else return 0.5;
    }

    var fillOpacityVal;
    var colorVal;
    var weightVal;

    function style(feature) {
      var setColor;
      if (colorVal == "") {
        setColor = getColor(feature.properties.no2Perc, feature.properties.demographicIndex, ((feature.properties[singleVariable] / feature.properties.popTotal)*100));
      }
      else setColor = colorVal;
      return {
          fillColor: getColor(feature.properties.no2Perc, feature.properties.demographicIndex, ((feature.properties[singleVariable] / feature.properties.popTotal)*100)),
          weight: getOutlineWeight(feature.properties.comboRank, weightVal),
          opacity: getOutlineOpacity(feature.properties.comboRank),
          color: getColorRanked(feature.properties.comboRank, setColor), // outline color
          dashArray: '0',
          smoothFactor: 1,
          fillOpacity: fillOpacityVal
      };
      /*if (feature.properties.comboRank <= 25) {
        if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
            layer.bringToFront();
        }
      }
      else {
        if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
            layer.bringToBack();
        }
      }*/
    }

    function highlightFeature(e) {
        var layer = e.target;

        if ((layer.feature.properties.GEOID) != (clickedTract)) { //if not a clicked tract

          layer.setStyle({
            weight: 5,
            color: getOutlineColor(layer.feature.properties.comboRank, getColor(layer.feature.properties.no2Perc, layer.feature.properties.demographicIndex, ((layer.feature.properties[singleVariable] / layer.feature.properties.popTotal)*100))),
            //fill: false
            //fillColor: '#FFFFFF'
            fillOpacity: 0.4
          });
          /*if (layer.feature.properties.comboRank <= 15) {
            if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
                layer.bringToFront();
            }
          }*/

        }
        info.update(layer.feature.properties);
    }

    function resetHighlight(e) {
      var layer = e.target;
      if ((layer.feature.properties.GEOID) != (clickedTract)) {
        geojson.resetStyle(e.target);
      }
      //info.update();
    }

    function zoomToFeature(e) {
        var layer = e.target;
        clickEvent = e;

        //map.fitBounds(e.target.getBounds(), {top: 50000000000000000000000, bottom: 50000000000000000000000, left: 50000000000000000000000, right: 50000000000000000000000});
        //map.fitBounds(bounds, {padding: []})
        if (zoom == true) {
          //var latlng = layer.getLatLng();
          var zoomLevel = 14;
          map.setView(e.latlng, zoomLevel);
        //map.fitBounds(e.target.getBounds(), {padding: [100, 100]});
        }

        zoom = true;

        layer.setStyle({
          weight: 5,
          color: getColor(layer.feature.properties.no2Perc, layer.feature.properties.demographicIndex, ((layer.feature.properties[singleVariable] / layer.feature.properties.popTotal)*100)),
          //fill: false
          //fillColor: '#FFFFFF'
          fillOpacity: 0
        });

        /*if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
            layer.bringToFront();
        }*/

        info.update(layer.feature.properties);

        clickedTract = layer.feature.properties.GEOID;

        if ((previousTarget != "") && (previousTarget != e)) resetHighlight(previousTarget);

        previousTarget = e;

    }

    function onEachFeature(feature, layer) {
        layer.on({
            mouseover: highlightFeature,
            mouseout: resetHighlight,
            click: zoomToFeature
        });
    }

    // method that we will use to update the control based on feature properties passed
    /*info.update = function (props) {
        this._div.innerHTML = '<h2>NO<sub>2</sub> Equality Index</h2>' +  (props ?
            '<h3>NO<sub>2</sub> Index: ' + props.no2Perc + '</h3><br /><h3>Demographic Index: ' + props.demographicIndex + '</h3><br /><h3>Tract #' + props.TRACT + '</h3><br />'
            : 'Click on a census tract');
    };*/

    function updateImg() {

      var div = L.DomUtil.create('div', 'grid-container');
      div.id = gridContainerID;
      var grades = [1, 40, 90];
      //<div class='popup' onclick='popItUp(\"no2AxisPopup\")' style='bottom:5px; left:5px;' ><img src='images/info.png' style='width:30px;height:30px;'></img><span class='popuptext' id='no2AxisPopup'><p><strong>Title: </strong></br>Description</p></span></div>
      //div.innerHTML += '<img src="images/no2dLegend.png" alt="Legend" style="width:300px;height:300px;">';
      div.innerHTML += "<div class='xButton' onclick='xButton(\"gridContainer\", \"inline-grid\")' ><h2>✕</h2></div><h3 class='axis' >Nitrogen Dioxide Percentile</h3><div class=\"grid-item\" style=\"background:" + getColor(grades[2],grades[0],"") + "\" id:\"a3\" ></div><div class=\"grid-item\" style=\"background:" + getColor(grades[2],grades[1],"") + "\" id:\"b3\" ></div><div class=\"grid-item\" style=\"background:" + getColor(grades[2],grades[2],"") + "\" id:\"c3\" ></div>";
      div.innerHTML += "<div class=\"grid-item\" style=\"background:" + getColor(grades[1],grades[0],"") + "\" id:\"a2\"></div><div class=\"grid-item\" style=\"background:" + getColor(grades[1],grades[1],"") + "\" id:\"b2\" ></div><div class=\"grid-item\" style=\"background:" + getColor(grades[1],grades[2],"") + "\" id:\"c2\" ></div>";
      div.innerHTML += "<div class=\"grid-item\" style=\"background:" + getColor(grades[0],grades[0],"") + "\" id:\"a1\" ></div><div class=\"grid-item\" style=\"background:" + getColor(grades[0],grades[1],"") + "\" id:\"b1\" ></div><div class=\"grid-item\" style=\"background:" + getColor(grades[0],grades[2],"") + "\" id:\"c1\" ></div><h2 class='axis' >Socio-Demographic Index</h2>";

      //<button type=\"button\" class=\"collapsible\" id=\"collapse1\" onclick=\"toggleLegend()\"  >

      div.style.display = "inline-grid";

      var draggable = new L.Draggable(div);
      draggable.enable();

      return div;
    }

    /*img.onAdd = function (map) {
      var div = L.DomUtil.create('div', 'grid-container');
      div.id = "gridContainer";
      grades = [1, 40, 80];
      //div.innerHTML += '<img src="images/no2dLegend.png" alt="Legend" style="width:300px;height:300px;">';
      div.innerHTML += "<h3 class='axis'>Nitrogen Dioxide Index</h3><div class=\"grid-item\" style=\"background:" + getColor(grades[2],grades[0]) + "\" id:\"a3\" ></div><div class=\"grid-item\" style=\"background:" + getColor(grades[2],grades[1]) + "\" id:\"b3\" ></div><div class=\"grid-item\" style=\"background:" + getColor(grades[2],grades[2]) + "\" id:\"c3\" ></div>";
      div.innerHTML += "<div class=\"grid-item\" style=\"background:" + getColor(grades[1],grades[0]) + "\" id:\"a2\"></div><div class=\"grid-item\" style=\"background:" + getColor(grades[1],grades[1]) + "\" id:\"b2\" ></div><div class=\"grid-item\" style=\"background:" + getColor(grades[1],grades[2]) + "\" id:\"c2\" ></div>";
      div.innerHTML += "<div class=\"grid-item\" style=\"background:" + getColor(grades[0],grades[0]) + "\" id:\"a1\" ></div><div class=\"grid-item\" style=\"background:" + getColor(grades[0],grades[1]) + "\" id:\"b1\" ></div><div class=\"grid-item\" style=\"background:" + getColor(grades[0],grades[2]) + "\" id:\"c1\" ></div><h2 class='axis' >Demographic Index</h2>";

      var draggable = new L.Draggable(div);
      draggable.enable();

      return div;
    }//"#f3f3f3 url('img_tree.png') no-repeat right top";*/

    function setPalette(num) {
      var sourcesWasOn = false;
      if (sourcesIsOn) {
        sourcesWasOn = true;
        toggleLayer(sources);
      }
      if (num == 1) {
        colors = paletteA;
        //select button1
        changeButtonSelection("button1", "button2");
      }
      if (num == 2) {
        colors = paletteB;
        //select button2
        changeButtonSelection("button2", "button1");
      }

      updateImg();
      img.addTo(map);
      if (hiddenLegends.includes(gridContainerID)) {
        document.getElementById(gridContainerID + "Button").style.display = "none";
      }

      numVars = 2;

        if (houstonIsOn) { // Repaint Houston layer
          map.removeLayer(houston);

          geojson = L.geoJson(houLayer);

          houston = L.geoJson(houLayer, {
              style: style,
              onEachFeature: onEachFeature
          });

          var layer = houston.addTo(map);

          geojson = layer;
        }
        if (dcIsOn) { // Repaint DC layer
          map.removeLayer(dc);

          geojson = L.geoJson(dcLayer);

          dc = L.geoJson(dcLayer, {
              style: style,
              onEachFeature: onEachFeature
          });
          var layer = dc.addTo(map);

          geojson = layer;
        }

        if (sourcesWasOn) {
          toggleLayer(sources);
        }

        zoom = false;
        zoomToFeature(clickEvent);
        zoom = true;
  }

  /*
  idOn    id of button to select
  idOff   id of button to deselect
  */
  function changeButtonSelection(idOn, idOff) {

    if (idOn != "") {
      var eleOn = document.getElementById(idOn);

      //if eleOn does not have selected class, add it
      if (!(eleOn.classList.contains("selected"))) {
        eleOn.classList.add("selected");
      }
    }

    if (idOff != "") {
      var eleOff = document.getElementById(idOff);

      //if eleOff has selected class, remove it
      if (eleOff.classList.contains("selected")) {
        eleOff.classList.remove("selected");
      }
    }

    //return true
    return true;
  }

  // univariate choropleth legend
  function uniLegend() {

    var div = document.getElementById(gridContainerID);
    var grades = [0, 10, 20, 30, 40, 50, 60, 70, 80, 90];
    //<div class='popup' onclick='popItUp(\"no2AxisPopup\")' style='bottom:5px; left:5px;' ><img src='images/info.png' style='width:30px;height:30px;'></img><span class='popuptext' id='no2AxisPopup'><p><strong>Title: </strong></br>Description</p></span></div>
    //div.innerHTML += '<img src="images/no2dLegend.png" alt="Legend" style="width:300px;height:300px;">';

    div.innerHTML = '<img src="images/uniLegend.png" alt="Legend" style="width:200px;height:370px;margin-right:50px;margin-top:30px;"></img>';
    //<div class="xButton" onclick="xButton(\"gridContainer\", \"inline-grid\")" style="right:35px;top:-43px;"><h2>✕</h2></div>
    /*for (var i = grades.length-1; i > 0; i--) {
        div.innerHTML +=
            '<h4>' + grades[i] + '<i style="background:' + getColor(0,0,grades[i] + 1) + '"></i></h4>' +
            '</br>';
    }*/

    div.style.display = "inline-block";
    //div.style.lineHeight = '0px';
    div.style.padding = "0px";
    div.style.lineHeight = "20px";

    return div;
  }

  // NOx Point Sources
  var maxEmissions = 5658.8332;
  var minEmissions = 0.0000325;
  var rangeEmissions = maxEmissions - minEmissions;
  var numStepsEmissions = 100;

  function paintPointSources(feature, latlng) {
    var r = getCircleRadius(feature.properties.total_emissions);
      return L.circleMarker(latlng, {
        fillColor: '#000000',
        color: '#FFFFFF',
        weight: 1,
        opacity: 0.5,
        fillOpacity: 1,
        radius: r
    });
  }

  function onEachFeaturePointSources(feature, layer) {
      var book = feature.properties.company_name;
      if (book != "") log = "</br>Company name: " + book;
      else log = "";
      layer.bindPopup("Site name: " + titleCase(feature.properties.site_name.toLowerCase()) + log + "</br>Total Emissions: " + feature.properties.total_emissions + " tons\n");
  }

  /*L.geoJson(houSources,
    {
      pointToLayer: paintPointSources,
      onEachFeature: onEachFeaturePointSources
    }).addTo(map);*/


  /* secondary functions */

  function titleCase(phrase) {
    var words = phrase.split(" ");
    var title = "";

    for (var i = 0; i < words.length; i++) {
      title += words[i][0].toUpperCase() + words[i].substr(1) + " ";
    }

    return title;
  }

  function getCircleRadius(x) {
    /*for (var i = numStepsEmissions; i >= 0; i--) {
      if (num >= scaleStep(i)) return circleAreaToRadius(scaleStep(num));
    }
    return circleAreaToRadius(scaleStep(numStepsEmissions));*/
    var a = getArea(x)*30;
    var r = circleAreaToRadius(a);
    return r;
  }

  function getArea(x) {
    var m = maxEmissions;
    var n = 10;
    return x >= m - (m/n)  ? 30 :
           x >= m - 2*(m/n)  ? 27 :
           x >= m - 3*(m/n)  ? 24 :
           x >= m - 4*(m/n)  ? 21 :
           x >= m - 5*(m/n)  ? 18 :
           x >= m - 6*(m/n)  ? 15 :
           x >= m - 7*(m/n)  ? 12 :
           x >= m - 8*(m/n)  ? 9 : //high
           x >= m - 9*(m/n)  ? 6 : //mid
                    3; //low
  }

  function scaleStep(stepNum) {
    //var range = Math.round(maxEmissions - minEmissions);
    var range = 50;

    //var range = 50;
    var segment = range/numStepsEmissions;
    return segment*stepNum;
  }

  function circleAreaToRadius(area) {
    var radius = area/Math.PI;
    radius = Math.sqrt(radius);
    return (Math.round(radius * 100)/100);
  }

  var log = "";
  var sourcesIsOn = false;
  var sources;
  function toggleLayer(layer) {
    if (!sourcesIsOn) {
      sources = L.geoJson(houSources,
        {
          pointToLayer: paintPointSources,
          onEachFeature: onEachFeaturePointSources
        });

      sources.addTo(map);
      //alert(log);
      sourcesIsOn = true;

      document.getElementById("sources").classList.toggle("activated");
    }
    else {
      map.removeLayer(sources);
      sourcesIsOn = false;

      document.getElementById("sources").classList.toggle("activated");
    }

  }

  map.setZoom(10);

</script>
